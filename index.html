<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>客人預約日曆與房間視覺圖</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }
    h2 {
      font-size: 28px;
      margin-bottom: 20px;
      font-weight: bold;
      text-align: center;
    }
    #calendar, #bedListView, #roomMapView {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .fc-toolbar-title {
      font-size: 24px;
      font-weight: bold;
    }
    .fc-button {
      background-color: #4CAF50;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      color: white;
      transition: background-color 0.3s;
    }
    .fc-button:hover {
      background-color: #45a049;
    }
    .fc-event-title {
      white-space: pre-line;
      font-size: 14px;
      font-weight: bold;
    }
    .fc-event {
      border: none;
      border-radius: 8px;
      padding: 4px;
      font-size: 13px;
      line-height: 1.4;
    }
    .fc-daygrid-event {
      margin: 2px 0;
    }
    #refreshBtn, #toggleViewBtn, #toggleRoomViewBtn {
      background-color: #2196F3;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      color: white;
      font-size: 16px;
      transition: background-color 0.3s;
      margin: 10px 5px;
    }
    #refreshBtn:hover, #toggleViewBtn:hover, #toggleRoomViewBtn:hover {
      background-color: #1976D2;
    }
    .room-box {
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      min-height: 80px;
      background-color: #eee;
      transition: background-color 0.3s;
    }
    .room-box.occupied {
      background-color: #C8E6C9;
      border-color: #4CAF50;
      color: #2E7D32;
    }
    .room-title {
      font-weight: bold;
      margin-bottom: 6px;
    }
    .room-info {
      font-size: 14px;
      line-height: 1.4;
    }
    #bedTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #bedTable th, #bedTable td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    #bedTable th {
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <h2>客人預約管理</h2>
  <div style="text-align: center;">
    <button id="refreshBtn">立即重新整理</button>
    <button id="toggleViewBtn">切換至床位清單</button>
    <button id="toggleRoomViewBtn">切換至房間視覺圖</button>
  </div>
  <div id="calendar"></div>
  <div id="bedListView" style="display: none;">
    <h2>今日床位清單</h2>
    <table id="bedTable">
      <thead>
        <tr>
          <th>姓名</th>
          <th>電話</th>
          <th>房號</th>
          <th>房型</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="roomMapView" style="display: none;">
    <h2>房間視覺圖</h2>
    <div id="roomGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; max-width: 800px; margin: auto;"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    const webhookUrl = 'https://script.google.com/macros/s/YOUR_WEBHOOK_URL_HERE/exec';
    const idSheetUrl = 'https://script.google.com/macros/s/YOUR_IDSHEET_URL_HERE/exec';

    document.addEventListener('DOMContentLoaded', async function () {
      const calendarEl = document.getElementById('calendar');
      const bedListView = document.getElementById('bedListView');
      const roomMapView = document.getElementById('roomMapView');
      const toggleViewBtn = document.getElementById('toggleViewBtn');
      const toggleRoomViewBtn = document.getElementById('toggleRoomViewBtn');
      const bedTableBody = document.querySelector('#bedTable tbody');
      const roomGrid = document.getElementById('roomGrid');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'zh-tw',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        events: []
      });

      async function loadEvents() {
        const res = await fetch(webhookUrl);
        const data = await res.json();
        const events = data.map(item => ({
          title: `${item['商品名稱']}\n${item['姓名']} x${item['數量'] || 1}`,
          start: item['開始時間'],
          allDay: true
        }));
        calendar.removeAllEvents();
        calendar.addEventSource(events);
      }

      async function loadBedList() {
        bedTableBody.innerHTML = '';
        const res = await fetch(idSheetUrl);
        const data = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const todayData = data.filter(d => (d['開始時間'] || '').startsWith(today));
        todayData.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${d['姓名']}</td><td>${d['電話']}</td><td>${d['房號'] || '未分配'}</td><td>${d['商品名稱']}</td>`;
          bedTableBody.appendChild(tr);
        });
      }

      async function loadRoomMap() {
        roomGrid.innerHTML = '';
        const res = await fetch(idSheetUrl);
        const data = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const roomMap = {};
        for (let i = 1; i <= 12; i++) roomMap[i] = null;
        data.forEach(d => {
          const date = (d['開始時間'] || '').split('T')[0];
          const room = d['房號']?.toString();
          if (date === today && room && roomMap.hasOwnProperty(room)) {
            roomMap[room] = d;
          }
        });
        for (let i = 1; i <= 12; i++) {
          const info = roomMap[i];
          const box = document.createElement('div');
          box.classList.add('room-box');
          if (info) box.classList.add('occupied');
          box.innerHTML = `<div class="room-title">房號 ${i}</div><div class="room-info">${info ? `${info['姓名']}<br>${info['商品名稱']}` : '尚未分配'}</div>`;
          roomGrid.appendChild(box);
        }
      }

      document.getElementById('refreshBtn').onclick = async () => {
        await loadEvents();
      };

      toggleViewBtn.onclick = () => {
        calendarEl.style.display = 'none';
        bedListView.style.display = 'block';
        roomMapView.style.display = 'none';
        loadBedList();
      };

      toggleRoomViewBtn.onclick = () => {
        calendarEl.style.display = 'none';
        bedListView.style.display = 'none';
        roomMapView.style.display = 'block';
        loadRoomMap();
      };

      await loadEvents();
      calendar.render();
    });
  </script>
</body>
</html>
